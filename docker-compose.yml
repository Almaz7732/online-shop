version: '3.8'
services:
    app:
        build: ./laravel-app/docker/php
        container_name: laravel_app
        volumes:
            - ./laravel-app:/var/www/html
        environment:
            - APP_ENV=local
            - APP_DEBUG=true
        depends_on: [mysql_primary, redis, rabbitmq, clickhouse]
        networks:
            - appnet


    nginx:
        image: nginx:stable
        container_name: laravel_nginx
        ports:
            - "8080:80"
        volumes:
            - ./laravel-app/docker/nginx/site.conf:/etc/nginx/conf.d/default.conf:ro
            - ./laravel-app:/var/www/html
        depends_on: [app]
        networks:
            - appnet


    mysql_primary:
        image: mysql:8.0
        container_name: mysql_primary
        environment:
            MYSQL_DATABASE: laravel
            MYSQL_ROOT_PASSWORD: root
            MYSQL_USER: laravel
            MYSQL_PASSWORD: secret
        command:
            - --server-id=1
            - --log-bin=mysql-bin
            - --binlog-format=ROW
            - --gtid-mode=ON
            - --enforce-gtid-consistency=ON
            - --log-slave-updates=ON
        volumes:
            - mysql_primary_data:/var/lib/mysql
        networks:
            - appnet

    mysql_replica:
        image: mysql:8.0
        container_name: mysql_replica
        environment:
            MYSQL_ROOT_PASSWORD: root
        command:
            - --server-id=2
            - --log-bin=mysql-bin
            - --relay-log=mysql-relay-bin
            - --gtid-mode=ON
            - --enforce-gtid-consistency=ON
            - --log-slave-updates=ON
            - --read-only=ON
        volumes:
            - mysql_replica_data:/var/lib/mysql
        depends_on:
            - mysql_primary
        networks:
            - appnet

    mysql_replica_2:
        image: mysql:8.0
        container_name: mysql_replica_2
        environment:
            MYSQL_ROOT_PASSWORD: root
        command:
            - --server-id=3
            - --log-bin=mysql-bin
            - --relay-log=mysql-relay-two-bin
            - --gtid-mode=ON
            - --enforce-gtid-consistency=ON
            - --read-only=ON
        volumes:
            - mysql_replica_data2:/var/lib/mysql
        depends_on:
            - mysql_primary
        networks:
            - appnet

    proxysql:
        image: proxysql/proxysql:latest
        container_name: proxysql
        ports:
            - "6033:6033"   # MySQL clients
            - "6032:6032"   # Admin interface
        networks:
            - appnet


    phpmyadmin:
        image: phpmyadmin:latest
        container_name: phpmyadmin
        restart: unless-stopped
        environment:
            PMA_HOST: mysql_primary
            PMA_PORT: 3306
            PMA_USER: root
            PMA_PASSWORD: root
        ports:
            - "8081:80"
        depends_on:
            - mysql_primary
        networks:
            - appnet


    redis:
        image: redis:7
        container_name: laravel_redis
        networks:
            - appnet


    rabbitmq:
        image: rabbitmq:3-management
        container_name: laravel_rabbitmq
        ports:
            - "5672:5672"   # AMQP
            - "15672:15672" # management
        networks:
            - appnet


    clickhouse:
        image: yandex/clickhouse-server:latest
        container_name: clickhouse
        ports:
            - "8123:8123"   # HTTP
            - "9000:9000"   # Native protocol
        ulimits:
            nofile:
                soft: 262144
                hard: 262144
        volumes:
            - clickhouse_data:/var/lib/clickhouse
        networks:
            - appnet

    clickhouse-ui:
        image: spoonest/clickhouse-tabix-web-client:latest
        container_name: clickhouse_tabix
        restart: unless-stopped
        ports:
            - "8084:80"      # Web-UI
        environment:
            CH_SERVER: clickhouse
            CH_PORT: 8123
            CH_LOGIN: default
            CH_PASSWORD: ""
            CH_DEFAULT_DB: default
        depends_on:
            - clickhouse
        networks:
            - appnet


    go_notification:
        build: ./go-notification
        container_name: go_notification_worker
        depends_on:
            - rabbitmq
        environment:
            - RABBITMQ_HOST=rabbitmq
            - RABBITMQ_PORT=5672
            - RABBITMQ_USER=guest
            - RABBITMQ_PASSWORD=guest
            - RABBITMQ_VHOST=/
            - RABBITMQ_QUEUE=default
            - RABBITMQ_EXCHANGE=laravel
            - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
            - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
            - WORKER_COUNT=5
            - RETRY_COUNT=3
            - RETRY_DELAY=60s
        restart: unless-stopped
        networks:
            - appnet


volumes:
    mysql_primary_data:
    mysql_replica_data:
    mysql_replica_data2:
    clickhouse_data:
    redis_insight_data:


networks:
    appnet:
        driver: bridge
